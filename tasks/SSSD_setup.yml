---

- name: Ensure SSSD packages are present (provider-aware)
  ansible.builtin.package:
    name: >-
      {{
        (sssd_provider == 'ad')
        | ternary(['sssd','sssd-ad'], ['sssd','sssd-ldap'])
      }}
    state: present

- name: Ensure /etc/sssd exists
  ansible.builtin.file:
    path: /etc/sssd
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy /etc/sssd/sssd.conf from template
  ansible.builtin.template:
    src: templates/sssd.conf.j2
    dest: /etc/sssd/sssd.conf
    owner: root
    group: root
    mode: "0600"

- name: Validate SSSD configuration
  ansible.builtin.command: sssctl config-check
  register: _sssctl
  changed_when: false
  failed_when: _sssctl.rc != 0